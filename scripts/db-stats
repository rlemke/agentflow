#!/usr/bin/env bash
# Display AgentFlow database statistics.
#
# Shows document counts and state breakdowns for all collections:
# runners, steps, events, flows, workflows, tasks, logs, servers, locks.
#
# Usage:
#   scripts/db-stats                              # use default config
#   scripts/db-stats --config /path/to/config.json
#   scripts/db-stats --json                       # output as JSON

set -euo pipefail

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"

# Load shared env (.env sets AFL_MONGODB_URL etc.)
source "$(dirname "$0")/_env.sh"

PYTHON="${REPO_ROOT}/.venv/bin/python3"
[[ -x "$PYTHON" ]] || PYTHON=python3

CONFIG_ARG=""
JSON_OUTPUT="false"

while [[ $# -gt 0 ]]; do
    case "$1" in
        --config)      CONFIG_ARG="$2"; shift 2 ;;
        --json)        JSON_OUTPUT="true"; shift ;;
        --help|-h)
            awk 'NR==1{next} /^#/{sub(/^# ?/,""); print; next} {exit}' "$0"
            exit 0
            ;;
        *) echo "Unknown option: $1" >&2; exit 1 ;;
    esac
done

exec env PYTHONPATH="$REPO_ROOT" "$PYTHON" -c "
import json
import sys

config_path = '${CONFIG_ARG}' or None
json_output = '${JSON_OUTPUT}' == 'true'

from afl.config import load_config

config = load_config(config_path)

try:
    from pymongo import MongoClient
except ImportError:
    print('Error: pymongo is required. Install with: pip install pymongo', file=sys.stderr)
    sys.exit(1)

client = MongoClient(config.mongodb.connection_string())
db = client[config.mongodb.database]

collections = ['runners', 'steps', 'events', 'flows', 'workflows',
               'tasks', 'logs', 'servers', 'locks']

stats = {}

for name in collections:
    coll = db[name]
    total = coll.count_documents({})

    info = {'total': total}

    # State breakdowns for relevant collections
    if name in ('runners', 'tasks', 'servers', 'events', 'steps'):
        pipeline = [
            {'\$group': {'_id': '\$state', 'count': {'\$sum': 1}}},
            {'\$sort': {'count': -1}},
        ]
        by_state = {}
        for doc in coll.aggregate(pipeline):
            state = doc['_id'] or 'null'
            by_state[state] = doc['count']
        if by_state:
            info['by_state'] = by_state

    # Runner duration stats
    if name == 'runners' and total > 0:
        pipeline = [
            {'\$match': {'duration': {'\$gt': 0}}},
            {'\$group': {
                '_id': None,
                'avg_duration_ms': {'\$avg': '\$duration'},
                'max_duration_ms': {'\$max': '\$duration'},
            }},
        ]
        for doc in coll.aggregate(pipeline):
            info['avg_duration_ms'] = round(doc.get('avg_duration_ms', 0))
            info['max_duration_ms'] = doc.get('max_duration_ms', 0)

    stats[name] = info

client.close()

if json_output:
    print(json.dumps(stats, indent=2))
else:
    print(f'AgentFlow Database: {config.mongodb.database}')
    print(f'Server: {config.mongodb.url}')
    print('=' * 60)
    print()

    for name, info in stats.items():
        total = info['total']
        print(f'  {name:<14} {total:>6} documents')

        if 'by_state' in info:
            for state, count in info['by_state'].items():
                print(f'    {\"\":>14} {state}: {count}')

        if 'avg_duration_ms' in info:
            avg = info['avg_duration_ms']
            mx = info['max_duration_ms']
            print(f'    {\"\":>14} avg duration: {avg}ms, max: {mx}ms')

    print()
    total_docs = sum(i['total'] for i in stats.values())
    print(f'  {\"TOTAL\":<14} {total_docs:>6} documents')
    print()
"
