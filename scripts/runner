#!/usr/bin/env bash
# Start the AFL distributed runner service.
#
# The runner polls MongoDB for blocked steps and pending tasks, acquires
# distributed locks, and dispatches events to registered tool handlers.
# Multiple instances can run concurrently on different machines.
#
# Usage:
#   scripts/runner                                  # start with defaults
#   scripts/runner --config /path/to/afl.config.json
#   scripts/runner --topics TopicA TopicB           # handle specific topics
#   scripts/runner --max-concurrent 10              # allow 10 parallel items
#
# Options:
#   --config FILE            Path to AFL config file
#   --server-group GROUP     Server group name (default: default)
#   --service-name NAME      Service name (default: afl-runner)
#   --server-name HOST       Server hostname (default: auto-detect)
#   --topics TOPIC...        Event topics to handle
#   --task-list NAME         Task list to poll (default: default)
#   --poll-interval MS       Poll interval in ms (default: 2000)
#   --heartbeat-interval MS  Heartbeat interval in ms (default: 10000)
#   --max-concurrent N       Max concurrent work items (default: 5)
#   --lock-duration MS       Lock TTL in ms (default: 60000)
#   --help                   Show this help message

set -euo pipefail

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"

PYTHON="${REPO_ROOT}/.venv/bin/python3"
[[ -x "$PYTHON" ]] || PYTHON=python3

exec env PYTHONPATH="$REPO_ROOT" "$PYTHON" -m afl.runtime.runner "$@"
