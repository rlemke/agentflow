#!/usr/bin/env bash
# AgentFlow Docker Teardown Script
#
# Stops all AgentFlow containers and optionally removes volumes.
#
# Usage:
#   scripts/teardown                # Stop and remove containers
#   scripts/teardown --volumes      # Also remove Docker volumes
#   scripts/teardown --all          # Remove containers, volumes, and images
#
set -euo pipefail

REMOVE_VOLUMES=false
REMOVE_IMAGES=false

usage() {
    cat <<'EOF'
Usage: scripts/teardown [OPTIONS]

Stop and remove all AgentFlow Docker containers.

Options:
  --volumes, -v   Also remove Docker volumes (MongoDB data, HDFS data, etc.)
  --all           Remove containers, volumes, and built images
  -h, --help      Show this help message
EOF
}

# ---------------------------------------------------------------------------
# Parse arguments
# ---------------------------------------------------------------------------
while [[ $# -gt 0 ]]; do
    case "$1" in
        --volumes|-v)    REMOVE_VOLUMES=true;   shift ;;
        --all)           REMOVE_VOLUMES=true; REMOVE_IMAGES=true; shift ;;
        -h|--help)       usage; exit 0 ;;
        *)
            echo "Unknown option: $1" >&2
            usage >&2
            exit 1
            ;;
    esac
done

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$PROJECT_DIR"

# Build the full list of compose files and profiles so that services started
# with overlay files (HDFS, PostGIS, mirror) are also stopped cleanly.
COMPOSE_FILES="-f docker-compose.yml"
for overlay in docker-compose.hdfs.yml docker-compose.postgis.yml docker-compose.mirror.yml; do
    if [ -f "$overlay" ]; then
        COMPOSE_FILES="$COMPOSE_FILES -f $overlay"
    fi
done

PROFILE_ARGS="--profile hdfs --profile jenkins --profile postgis --profile localstack --profile seed --profile mcp"

DOWN_ARGS=""
if [ "$REMOVE_VOLUMES" = true ]; then
    DOWN_ARGS="$DOWN_ARGS --volumes"
fi
if [ "$REMOVE_IMAGES" = true ]; then
    DOWN_ARGS="$DOWN_ARGS --rmi local"
fi

echo "=== AgentFlow Docker Teardown ==="
echo ""
echo "  Remove volumes: $REMOVE_VOLUMES"
echo "  Remove images:  $REMOVE_IMAGES"
echo ""

docker compose $COMPOSE_FILES $PROFILE_ARGS down $DOWN_ARGS

echo ""
echo "Teardown complete."
if [ "$REMOVE_VOLUMES" = true ]; then
    echo "  Volumes removed — all persistent data has been deleted."
else
    echo "  Volumes preserved — data will persist for next startup."
    echo "  Use --volumes to also remove persistent data."
fi
echo ""
