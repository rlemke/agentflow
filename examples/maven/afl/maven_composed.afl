namespace maven.composed {
    use maven.types
    use maven.mixins
    use maven.resolve
    use maven.build
    use maven.quality

    // Composed facet: resolve → compile(+Retry) → test(+Timeout) → package
    facet CompileAndTest(group_id: String, artifact_id: String,
        version: String,
        workspace_path: String) => (artifact_path: String,
            test_passed: Long, test_total: Long,
            build_duration_ms: Long) andThen {

        deps = maven.resolve.ResolveDependencies(group_id = $.group_id,
            artifact_id = $.artifact_id, version = $.version)
        build = maven.build.CompileProject(workspace_path = $.workspace_path,
            goals = "clean compile") with Retry(maxAttempts = 2)
        tests = maven.build.RunUnitTests(workspace_path = $.workspace_path,
            parallel = true) with Timeout(minutes = 15)
        pkg = maven.build.PackageArtifact(workspace_path = $.workspace_path,
            packaging = "jar")

        yield CompileAndTest(
            artifact_path = pkg.info.path,
            test_passed = tests.report.passed,
            test_total = tests.report.total,
            build_duration_ms = build.result.duration_ms)
    }

    // Composed facet: checkstyle + dependency check with arithmetic
    facet FullQualityGate(workspace_path: String,
        severity_threshold: String = "warning",
        fail_on_cvss: Double = 7.0) => (quality_issues: Long,
            security_issues: Long, total_issues: Long,
            quality_passed: Boolean) andThen {

        style = maven.quality.CheckstyleAnalysis(workspace_path = $.workspace_path,
            severity_threshold = $.severity_threshold) with Timeout(minutes = 10)
        security = maven.quality.DependencyCheck(workspace_path = $.workspace_path,
            fail_on_cvss = $.fail_on_cvss) with Timeout(minutes = 15)

        yield FullQualityGate(
            quality_issues = style.report.issues,
            security_issues = security.report.issues,
            total_issues = style.report.issues + security.report.issues,
            quality_passed = style.report.passed)
    }
}
