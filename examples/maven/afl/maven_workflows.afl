namespace maven.workflows {

    use maven.types
    use maven.mixins

    // -----------------------------------------------------------------------
    // Workflow 1: BuildAndTest — basic lifecycle
    // resolve -> compile -> test -> package
    // -----------------------------------------------------------------------
    workflow BuildAndTest(group_id: String, artifact_id: String,
        version: String,
        workspace_path: String) => (artifact_path: String,
            test_passed: Long, test_total: Long,
            build_version: String) andThen {

        deps = maven.resolve.ResolveDependencies(group_id = $.group_id,
            artifact_id = $.artifact_id, version = $.version)

        build = maven.build.CompileProject(workspace_path = $.workspace_path,
            goals = "clean compile")

        tests = maven.build.RunUnitTests(workspace_path = $.workspace_path,
            parallel = true)

        pkg = maven.build.PackageArtifact(workspace_path = $.workspace_path,
            packaging = "jar")

        yield BuildAndTest(
            artifact_path = pkg.info.path,
            test_passed = tests.report.passed,
            test_total = tests.report.total,
            build_version = deps.info.version)
    }

    // -----------------------------------------------------------------------
    // Workflow 2: ReleaseArtifact — full release pipeline
    // resolve -> compile + Retry -> test -> package -> deploy + Repository
    // -----------------------------------------------------------------------
    workflow ReleaseArtifact(group_id: String, artifact_id: String,
        version: String, workspace_path: String,
        repository_url: String) => (deploy_url: String,
            published: Boolean,
            test_passed: Long) andThen {

        deps = maven.resolve.ResolveDependencies(group_id = $.group_id,
            artifact_id = $.artifact_id, version = $.version)

        build = maven.build.CompileProject(workspace_path = $.workspace_path,
            goals = "clean compile") with Retry(maxAttempts = 2, backoffSeconds = 60)

        tests = maven.build.RunUnitTests(workspace_path = $.workspace_path,
            parallel = true) with Timeout(minutes = 20)

        pkg = maven.build.PackageArtifact(workspace_path = $.workspace_path,
            packaging = "jar", attach_sources = true)

        deploy = maven.publish.DeployToRepository(artifact_path = pkg.info.path,
            repository_url = $.repository_url,
            group_id = $.group_id, artifact_id = $.artifact_id,
            version = $.version) with Repository(url = $.repository_url, type = "release")

        yield ReleaseArtifact(
            deploy_url = deploy.result.repository_url,
            published = deploy.result.published,
            test_passed = tests.report.passed)
    }

    // -----------------------------------------------------------------------
    // Workflow 3: DependencyAudit — quality pipeline
    // resolve -> analyze -> checkstyle + dependency check
    // -----------------------------------------------------------------------
    workflow DependencyAudit(group_id: String, artifact_id: String,
        version: String,
        workspace_path: String) => (total_dependencies: Long,
            conflicts: Long,
            quality_issues: Long,
            security_issues: Long) andThen {

        deps = maven.resolve.ResolveDependencies(group_id = $.group_id,
            artifact_id = $.artifact_id, version = $.version)

        tree = maven.resolve.AnalyzeDependencyTree(group_id = $.group_id,
            artifact_id = $.artifact_id, version = $.version,
            verbose = true)

        style = maven.quality.CheckstyleAnalysis(workspace_path = $.workspace_path,
            severity_threshold = "error")

        security = maven.quality.DependencyCheck(workspace_path = $.workspace_path,
            fail_on_cvss = 7.0)

        yield DependencyAudit(
            total_dependencies = tree.tree.total_dependencies,
            conflicts = tree.tree.conflicts,
            quality_issues = style.report.issues,
            security_issues = security.report.issues)
    }

    // -----------------------------------------------------------------------
    // Workflow 4: MultiModuleBuild — foreach parallel modules
    // foreach module: compile -> test -> package
    // -----------------------------------------------------------------------
    workflow MultiModuleBuild(group_id: String,
        workspace_path: String,
        modules: Json) => (artifact_path: String,
            module_name: String,
            test_passed: Long) andThen foreach mod in $.modules {

        build = maven.build.CompileProject(workspace_path = $.workspace_path,
            goals = "clean compile -pl " ++ $.mod.name) with Timeout(minutes = 20)

        tests = maven.build.RunUnitTests(workspace_path = $.workspace_path,
            test_suite = $.mod.test_suite) with Timeout(minutes = 15) with Retry(maxAttempts = 2)

        pkg = maven.build.PackageArtifact(workspace_path = $.workspace_path,
            packaging = $.mod.packaging) with Timeout(minutes = 10)

        yield MultiModuleBuild(
            artifact_path = pkg.info.path,
            module_name = $.mod.name,
            test_passed = tests.report.passed)
    }
}
