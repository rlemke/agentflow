// US Census TIGER/Line voting district data
//
// Downloads and processes electoral boundary data from the US Census Bureau.
// Supports Congressional Districts, State Legislative Districts, and Voting Precincts.

/** Shared type definitions for US Census TIGER/Line electoral boundary data. */
namespace census.types {
    /** Cached TIGER/Line shapefile download metadata. */
    schema TIGERCache {
        url: String,
        path: String,
        date: String,
        size: Long,
        wasInCache: Boolean,
        year: Long,
        district_type: String,
        state_fips: String
    }

    /** Result of a voting-district extraction or conversion operation. */
    schema VotingDistrictResult {
        output_path: String,
        feature_count: Long,
        district_type: String,
        state: String,
        year: Long,
        format: String,
        extraction_date: String
    }
}

/** Event facets for downloading TIGER/Line electoral boundary shapefiles from the US Census Bureau. */
namespace census.tiger.Districts {
    use census.types
    /** Downloads nationwide Congressional District boundaries for a given congress. */
    event facet CongressionalDistricts(year: Long = 2023,
        congress_number: Long = 118) => (cache: TIGERCache)

    /** Downloads state senate (upper chamber) district boundaries by FIPS code. */
    event facet StateSenateDistricts(state_fips: String,
        year: Long = 2023) => (cache: TIGERCache)

    /** Downloads state house/assembly (lower chamber) district boundaries by FIPS code. */
    event facet StateHouseDistricts(state_fips: String,
        year: Long = 2023) => (cache: TIGERCache)

    /** Downloads voting precinct boundaries (available from decennial census years). */
    event facet VotingPrecincts(state_fips: String,
        year: Long = 2020) => (cache: TIGERCache)

    /** Downloads senate, house, and precinct boundaries for a state in one call. */
    event facet AllStateDistricts(state_fips: String,
        year: Long = 2023) => (senate: TIGERCache, house: TIGERCache, precincts: TIGERCache)
}

/** Processing facets for converting and filtering TIGER/Line shapefiles. */
namespace census.tiger.Processing {
    use census.types

    /** Converts a downloaded TIGER shapefile to GeoJSON format. */
    event facet ShapefileToGeoJSON(cache: TIGERCache) => (result: VotingDistrictResult)

    /** Spatially joins voting districts with OSM administrative boundaries. */
    event facet JoinWithOSMBoundaries(districts: VotingDistrictResult,
        osm_boundaries_path: String) => (result: VotingDistrictResult)

    /** Filters districts by a named attribute (e.g., district number or name). */
    event facet FilterDistricts(input_path: String,
        attribute: String, value: String) => (result: VotingDistrictResult)
}

// Convenience workflows for common use cases

/** Convenience workflows for common electoral boundary retrieval tasks. */
namespace census.tiger.Workflows {
    use census.types

    /** Looks up the 2-digit FIPS code for a state name. */
    facet StateFIPS(state: String) => (fips: String)

    /** Downloads Congressional District boundaries and converts them to GeoJSON. */
    workflow GetCongressionalDistricts(year: Long = 2023, congress_number: Long = 118) => (result: VotingDistrictResult) andThen {
        download = census.tiger.Districts.CongressionalDistricts(year = $.year, congress_number = $.congress_number)
        convert = census.tiger.Processing.ShapefileToGeoJSON(cache = download.cache)
        yield GetCongressionalDistricts(result = convert.result)
    }

    /** Downloads and converts senate, house, and precinct boundaries for a state to GeoJSON. */
    workflow GetStateVotingBoundaries(state_fips: String, year: Long = 2023) => (senate: VotingDistrictResult, house: VotingDistrictResult, precincts: VotingDistrictResult) andThen {
        senate_dl = census.tiger.Districts.StateSenateDistricts(state_fips = $.state_fips, year = $.year)
        house_dl = census.tiger.Districts.StateHouseDistricts(state_fips = $.state_fips, year = $.year)
        precincts_dl = census.tiger.Districts.VotingPrecincts(state_fips = $.state_fips, year = 2020)

        senate_json = census.tiger.Processing.ShapefileToGeoJSON(cache = senate_dl.cache)
        house_json = census.tiger.Processing.ShapefileToGeoJSON(cache = house_dl.cache)
        precincts_json = census.tiger.Processing.ShapefileToGeoJSON(cache = precincts_dl.cache)

        yield GetStateVotingBoundaries(senate = senate_json.result, house = house_json.result, precincts = precincts_json.result)
    }
}
