// GraphHopper workflow compositions
// Builds routing graphs from OSM caches for entire regions

namespace osm.geo.GraphHopper.Europe {
    use osm.types
    uses osm.geo.cache.Europe
    uses osm.geo.cache.GraphHopper.Europe

    // Build routing graphs for major European countries
    workflow BuildMajorEuropeGraphs(profile: String = "car", recreate: Boolean = false) => (graphs: [GraphHopperCache]) andThen {

        // Step 1: Get OSM caches (parallel)
        germany_osm = osm.geo.cache.Europe.Germany()
        france_osm = osm.geo.cache.Europe.France()
        spain_osm = osm.geo.cache.Europe.Spain()
        italy_osm = osm.geo.cache.Europe.Italy()
        uk_osm = osm.geo.cache.Europe.UnitedKingdom()
        poland_osm = osm.geo.cache.Europe.Poland()
        netherlands_osm = osm.geo.cache.Europe.Netherlands()
        belgium_osm = osm.geo.cache.Europe.Belgium()
        austria_osm = osm.geo.cache.Europe.Austria()
        switzerland_osm = osm.geo.cache.Europe.Switzerland()

        // Step 2: Build routing graphs (parallel)
        germany_gh = osm.geo.cache.GraphHopper.Europe.Germany(cache = germany_osm.cache, profile = $.profile, recreate = $.recreate)
        france_gh = osm.geo.cache.GraphHopper.Europe.France(cache = france_osm.cache, profile = $.profile, recreate = $.recreate)
        spain_gh = osm.geo.cache.GraphHopper.Europe.Spain(cache = spain_osm.cache, profile = $.profile, recreate = $.recreate)
        italy_gh = osm.geo.cache.GraphHopper.Europe.Italy(cache = italy_osm.cache, profile = $.profile, recreate = $.recreate)
        uk_gh = osm.geo.cache.GraphHopper.Europe.UnitedKingdom(cache = uk_osm.cache, profile = $.profile, recreate = $.recreate)
        poland_gh = osm.geo.cache.GraphHopper.Europe.Poland(cache = poland_osm.cache, profile = $.profile, recreate = $.recreate)
        netherlands_gh = osm.geo.cache.GraphHopper.Europe.Netherlands(cache = netherlands_osm.cache, profile = $.profile, recreate = $.recreate)
        belgium_gh = osm.geo.cache.GraphHopper.Europe.Belgium(cache = belgium_osm.cache, profile = $.profile, recreate = $.recreate)
        austria_gh = osm.geo.cache.GraphHopper.Europe.Austria(cache = austria_osm.cache, profile = $.profile, recreate = $.recreate)
        switzerland_gh = osm.geo.cache.GraphHopper.Europe.Switzerland(cache = switzerland_osm.cache, profile = $.profile, recreate = $.recreate)

        // Step 3: Aggregate results
        yield BuildMajorEuropeGraphs(graphs = germany_gh.graph ++ france_gh.graph ++ spain_gh.graph ++ italy_gh.graph ++ uk_gh.graph ++ poland_gh.graph ++ netherlands_gh.graph ++ belgium_gh.graph ++ austria_gh.graph ++ switzerland_gh.graph)
    }

    // Build a single country graph
    workflow BuildGermanyGraph(profile: String = "car", recreate: Boolean = false) => (graph: GraphHopperCache) andThen {
        osm = osm.geo.cache.Europe.Germany()
        gh = osm.geo.cache.GraphHopper.Europe.Germany(cache = osm.cache, profile = $.profile, recreate = $.recreate)
        yield BuildGermanyGraph(graph = gh.graph)
    }
}

namespace osm.geo.GraphHopper.NorthAmerica {
    use osm.types
    uses osm.geo.cache.NorthAmerica
    uses osm.geo.cache.GraphHopper.NorthAmerica

    // Build routing graphs for North America
    workflow BuildNorthAmericaGraphs(profile: String = "car", recreate: Boolean = false) => (graphs: [GraphHopperCache]) andThen {
        // Get OSM caches
        usa_osm = osm.geo.cache.NorthAmerica.UnitedStates()
        canada_osm = osm.geo.cache.NorthAmerica.Canada()
        mexico_osm = osm.geo.cache.NorthAmerica.Mexico()

        // Build graphs
        usa_gh = osm.geo.cache.GraphHopper.NorthAmerica.UnitedStates(cache = usa_osm.cache, profile = $.profile, recreate = $.recreate)
        canada_gh = osm.geo.cache.GraphHopper.NorthAmerica.Canada(cache = canada_osm.cache, profile = $.profile, recreate = $.recreate)
        mexico_gh = osm.geo.cache.GraphHopper.NorthAmerica.Mexico(cache = mexico_osm.cache, profile = $.profile, recreate = $.recreate)

        yield BuildNorthAmericaGraphs(graphs = usa_gh.graph ++ canada_gh.graph ++ mexico_gh.graph)
    }
}

namespace osm.geo.GraphHopper.UnitedStates {
    use osm.types
    uses osm.geo.cache.UnitedStates
    uses osm.geo.cache.GraphHopper.UnitedStates

    // Build routing graphs for US West Coast states
    workflow BuildWestCoastGraphs(profile: String = "car", recreate: Boolean = false) => (graphs: [GraphHopperCache]) andThen {
        ca_osm = osm.geo.cache.UnitedStates.California()
        or_osm = osm.geo.cache.UnitedStates.Oregon()
        wa_osm = osm.geo.cache.UnitedStates.Washington()

        ca_gh = osm.geo.cache.GraphHopper.UnitedStates.California(cache = ca_osm.cache, profile = $.profile, recreate = $.recreate)
        or_gh = osm.geo.cache.GraphHopper.UnitedStates.Oregon(cache = or_osm.cache, profile = $.profile, recreate = $.recreate)
        wa_gh = osm.geo.cache.GraphHopper.UnitedStates.Washington(cache = wa_osm.cache, profile = $.profile, recreate = $.recreate)

        yield BuildWestCoastGraphs(graphs = ca_gh.graph ++ or_gh.graph ++ wa_gh.graph)
    }

    // Build routing graphs for US East Coast states
    workflow BuildEastCoastGraphs(profile: String = "car", recreate: Boolean = false) => (graphs: [GraphHopperCache]) andThen {
        ny_osm = osm.geo.cache.UnitedStates.NewYork()
        nj_osm = osm.geo.cache.UnitedStates.NewJersey()
        ma_osm = osm.geo.cache.UnitedStates.Massachusetts()
        pa_osm = osm.geo.cache.UnitedStates.Pennsylvania()
        fl_osm = osm.geo.cache.UnitedStates.Florida()

        ny_gh = osm.geo.cache.GraphHopper.UnitedStates.NewYork(cache = ny_osm.cache, profile = $.profile, recreate = $.recreate)
        nj_gh = osm.geo.cache.GraphHopper.UnitedStates.NewJersey(cache = nj_osm.cache, profile = $.profile, recreate = $.recreate)
        ma_gh = osm.geo.cache.GraphHopper.UnitedStates.Massachusetts(cache = ma_osm.cache, profile = $.profile, recreate = $.recreate)
        pa_gh = osm.geo.cache.GraphHopper.UnitedStates.Pennsylvania(cache = pa_osm.cache, profile = $.profile, recreate = $.recreate)
        fl_gh = osm.geo.cache.GraphHopper.UnitedStates.Florida(cache = fl_osm.cache, profile = $.profile, recreate = $.recreate)

        yield BuildEastCoastGraphs(graphs = ny_gh.graph ++ nj_gh.graph ++ ma_gh.graph ++ pa_gh.graph ++ fl_gh.graph)
    }
}
