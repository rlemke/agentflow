// Volcano Query â€” find volcanoes by state and elevation
//
// Demonstrates a multi-step workflow: query a volcano data source,
// filter by elevation, and format results for display.

namespace volcano {

    schema Volcano {
        name: String,
        state: String,
        elevation_ft: Long,
        type: String,
        latitude: String,
        longitude: String
    }

    schema VolcanoList {
        volcanoes: Json,
        count: Long
    }

    schema FormattedResult {
        text: String,
        count: Long
    }

    event facet QueryVolcanoes(state: String, min_elevation_ft: Long) => (result: VolcanoList)

    event facet FormatVolcanoes(volcanoes: Json, count: Long) => (result: FormattedResult)

    // Single-state query: find volcanoes, then format results
    workflow FindVolcanoes(state: String, min_elevation_ft: Long) => (text: String, count: Long) andThen {
        query = QueryVolcanoes(state = $.state, min_elevation_ft = $.min_elevation_ft)
        fmt = FormatVolcanoes(volcanoes = query.result.volcanoes, count = query.result.count)
        yield FindVolcanoes(text = fmt.result.text, count = fmt.result.count)
    }

    // Multi-state query: iterate over a list of states in parallel
    workflow FindVolcanoesMultiState(states: Json, min_elevation_ft: Long) => (results: Json) andThen foreach st in $.states {
        query = QueryVolcanoes(state = st.value, min_elevation_ft = $.min_elevation_ft)
        fmt = FormatVolcanoes(volcanoes = query.result.volcanoes, count = query.result.count)
        yield FindVolcanoesMultiState(results = fmt.result)
    }

}
