{% extends "base.html" %}
{% block title %}Compile Result â€” AgentFlow Dashboard{% endblock %}
{% block content %}
<h1>Compile Result</h1>

{% if errors %}
<article aria-label="Errors" class="state-badge-failed">
    <header>Errors</header>
    <ul>
    {% for err in errors %}
        <li>
            {{ err.message }}
            {% if err.line %} (line {{ err.line }}{% if err.column %}, col {{ err.column }}{% endif %}){% endif %}
        </li>
    {% endfor %}
    </ul>
</article>
{% endif %}

{% if workflows %}
<form id="run-form" method="POST" action="/workflows/run">
    <input type="hidden" name="source" value="{{ source | e }}">
    <input type="hidden" name="inputs_json" id="inputs_json" value="{}">

    <h2>Select Workflow</h2>
    {% for wf in workflows %}
    <fieldset>
        <label>
            <input type="radio" name="workflow_name" value="{{ wf.name }}" {% if loop.first %}checked{% endif %}>
            <strong>{{ wf.name }}</strong>
        </label>
        {% if wf.params %}
        <table>
            <thead><tr><th>Parameter</th><th>Type</th><th>Default</th><th>Value</th></tr></thead>
            <tbody>
            {% for p in wf.params %}
                <tr>
                    <td>{{ p.name }}</td>
                    <td>{{ p.type if p.type else "Any" }}</td>
                    <td>{% if p.default is not none %}{{ p.default }}{% else %}<em>none</em>{% endif %}</td>
                    <td>
                        <input type="text"
                               class="param-input"
                               data-workflow="{{ wf.name }}"
                               data-param="{{ p.name }}"
                               value="{% if p.default is not none %}{{ p.default }}{% endif %}"
                               {% if p.default is none %}required{% endif %}>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No parameters.</p>
        {% endif %}
    </fieldset>
    {% endfor %}

    <button type="submit">Run Workflow</button>
</form>
<script>
document.getElementById("run-form").addEventListener("submit", function() {
    var selected = document.querySelector('input[name="workflow_name"]:checked');
    if (!selected) return;
    var wfName = selected.value;
    var inputs = {};
    document.querySelectorAll('.param-input[data-workflow="' + wfName + '"]').forEach(function(el) {
        var val = el.value;
        try { val = JSON.parse(val); } catch(e) {}
        inputs[el.dataset.param] = val;
    });
    document.getElementById("inputs_json").value = JSON.stringify(inputs);
});
</script>
{% elif not errors %}
<p>No workflows found in the source.</p>
{% endif %}

<p><a href="/workflows/new">Back to editor</a></p>
{% endblock %}
